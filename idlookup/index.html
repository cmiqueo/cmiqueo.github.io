<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity ID Lookup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }

        .form {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        input#input {
            width: 500px;
            display: block;
            margin: 0 auto;
            margin-bottom: 10px;
            height: 24px;
            font-size: 16px;
            font-family: monospace;
        }
        button#button {
            padding: 6px 50px;
            font-size: 16px;
            cursor: pointer;
        }
        p#output {
            font-size: 20px;
        }
        .disclaimer {
            margin: 20px auto;
            width: 720px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 0 10px 10px 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="form">
        <h1>Milo Entity ID Lookup</h1>
        <input type="text" id="input" placeholder="Enter production URL">
        <button id="button">Go</button>
        <p id="output"></p>
    </div>


    <div class="disclaimer">
        <p><b>Diclaimer</b></p>
        <p>This tool is good but not perfect. It is a simple tool to help you find the entity ID of a given URL.</p>
        <p>Some of the results may be incorrect. If you need to find the entity ID of a given URL, <br>
            please use the 
            <a href="https://rundeck.wcmsops.adobe.com/project/Chimera/job/show/65d2e474-6eb6-4732-988c-6eb59e22b66f">Milo Entity ID Lookup Tool</a>.</p>
    </div>



    </p>
    <script type="module">

        // UI elements
        const input = document.getElementById('input');
        const button = document.getElementById('button');
        const output = document.getElementById('output');

        button.addEventListener('click', async () => {
            console.log('button clicked');
            const id = await getUuid(input.value.split('https://').pop());
            output.textContent = id;
        });

        input.addEventListener('keyup', async (e) => {
            if (e.key === 'Enter') {
                button.click();
            }
        });


        // JS functions from getUuid.js
        const HEX_DIGITS = '0123456789abcdef'.split('');

        const sha1 = async (message) => {
        const data = new TextEncoder().encode(message);
        const hashBuf = await crypto.subtle.digest('SHA-1', data);
        return hashBuf;
        }

        const uint8ToHex = (int) => {
        const first = int >> 4;
        const second = int - (first << 4);
        return HEX_DIGITS[first] + HEX_DIGITS[second];
        };

        const uint8ArrayToHex = (buf) => [...buf]
        .map((int) => uint8ToHex(int))
        .join('');

        // generates uuid v5
        const hashToUuid = (buf) =>
        [
            uint8ArrayToHex(buf.slice(0, 4)),
            '-',
            uint8ArrayToHex(buf.slice(4, 6)),
            '-',
            uint8ToHex((buf[6] & 0x0f) | parseInt(5 * 10, 16)),
            uint8ToHex(buf[7]),
            '-',
            uint8ToHex((buf[8] & 0x3f) | 0x80),
            uint8ToHex(buf[9]),
            '-',
            uint8ArrayToHex(buf.slice(10, 16)),
        ].join('');

        const getUuid = async (str) => {  
            console.log('getUuid', str);
            const buf = await sha1(str);
            return hashToUuid(new Uint8Array(buf));
        }

        // focus on input when page loads
        input.focus();

    </script>
</body>
</html>